# Техническое задание (ТЗ)
## Система предиктивного мониторинга вибрации и температуры VibeMon

---

## 1. Общие сведения

### 1.1 Наименование проекта
**VibeMon** — Система предиктивного мониторинга вибрации и температуры для сельскохозяйственной и промышленной техники.

### 1.2 Назначение
Система предназначена для:
- Непрерывного мониторинга состояния механизмов и агрегатов
- Раннего обнаружения износа подшипников, дисбаланса, разрушения
- Предотвращения аварийных остановок техники
- Снижения затрат на обслуживание через предиктивную диагностику
- Удалённого контроля парка техники

### 1.3 Целевая аудитория
- Агропредприятия (комбайны, трактора, элеваторы)
- Промышленные предприятия (конвейеры, насосы, компрессоры)
- Сервисные компании по обслуживанию техники
- Логистические компании (грузовой транспорт)

---

## 2. Функциональные требования

### 2.1 Аппаратная часть (ESP32)

| Требование | Описание |
|------------|----------|
| FR-HW-001 | Измерение 3-осевой вибрации (акселерометр MPU6050) |
| FR-HW-002 | Измерение температуры (DS18B20, точность ±0.5°C) |
| FR-HW-003 | Передача данных по Bluetooth Low Energy 5.0 |
| FR-HW-004 | Работа от бортовой сети 12-24V с защитой |
| FR-HW-005 | Режим глубокого сна для экономии энергии |
| FR-HW-006 | OTA обновление прошивки через BLE и WiFi |
| FR-HW-007 | Локальное хранение данных при отсутствии связи |
| FR-HW-008 | LED индикация состояния устройства |
| FR-HW-009 | Кнопка сброса/сопряжения |

### 2.2 Мобильное приложение

| Требование | Описание |
|------------|----------|
| FR-APP-001 | Кроссплатформенность (Android 8+ / iOS 13+) |
| FR-APP-002 | Поиск и подключение к устройствам по BLE |
| FR-APP-003 | Отображение данных в реальном времени |
| FR-APP-004 | Интерактивные графики вибрации и температуры |
| FR-APP-005 | Дашборд с KPI и состоянием всех устройств |
| FR-APP-006 | Push-уведомления о критических событиях |
| FR-APP-007 | Офлайн-режим с локальным кэшированием |
| FR-APP-008 | Синхронизация с облаком при появлении сети |
| FR-APP-009 | Экран диагностики устройства |
| FR-APP-010 | Управление OTA обновлениями |
| FR-APP-011 | Настройка порогов предупреждений |
| FR-APP-012 | История измерений с фильтрацией |

### 2.3 Серверная часть

| Требование | Описание |
|------------|----------|
| FR-SRV-001 | REST API для мобильных приложений |
| FR-SRV-002 | WebSocket для real-time обновлений |
| FR-SRV-003 | Хранение временных рядов телеметрии |
| FR-SRV-004 | Модуль ИИ для анализа аномалий |
| FR-SRV-005 | Предиктивная диагностика износа |
| FR-SRV-006 | Система уведомлений (Telegram, Email, Push) |
| FR-SRV-007 | Аутентификация и авторизация (JWT) |
| FR-SRV-008 | Управление устройствами и прошивками |
| FR-SRV-009 | Экспорт отчётов (PDF, CSV) |
| FR-SRV-010 | Мультитенантность (несколько организаций) |

### 2.4 Веб-панель администратора

| Требование | Описание |
|------------|----------|
| FR-WEB-001 | Дашборд с общей статистикой |
| FR-WEB-002 | Карта расположения устройств |
| FR-WEB-003 | Детальные графики телеметрии |
| FR-WEB-004 | Управление пользователями и ролями |
| FR-WEB-005 | Список предупреждений и инцидентов |
| FR-WEB-006 | Настройка правил алертинга |
| FR-WEB-007 | Управление прошивками устройств |
| FR-WEB-008 | Журнал аудита действий |

---

## 3. Нефункциональные требования

### 3.1 Производительность

| Требование | Значение |
|------------|----------|
| NFR-PERF-001 | Частота измерений: до 1000 Hz (вибрация) |
| NFR-PERF-002 | Частота передачи: 1-10 пакетов/сек |
| NFR-PERF-003 | Задержка BLE: < 100 мс |
| NFR-PERF-004 | API latency: < 200 мс (p95) |
| NFR-PERF-005 | Поддержка до 1000 устройств на сервер |

### 3.2 Надёжность

| Требование | Значение |
|------------|----------|
| NFR-REL-001 | Uptime сервера: 99.5% |
| NFR-REL-002 | Локальный буфер: 24 часа данных |
| NFR-REL-003 | Автоматическое переподключение BLE |
| NFR-REL-004 | Резервное копирование БД: ежедневно |

### 3.3 Безопасность

| Требование | Описание |
|------------|----------|
| NFR-SEC-001 | Шифрование BLE (AES-128) |
| NFR-SEC-002 | HTTPS для всех API |
| NFR-SEC-003 | JWT токены с ротацией |
| NFR-SEC-004 | Подпись прошивок |
| NFR-SEC-005 | Ролевая модель доступа (RBAC) |

### 3.4 Масштабируемость

| Требование | Описание |
|------------|----------|
| NFR-SCAL-001 | Горизонтальное масштабирование API |
| NFR-SCAL-002 | Шардирование данных по организациям |
| NFR-SCAL-003 | Очереди сообщений для пиковых нагрузок |

---

## 4. Выбор технологического стека

### 4.1 Мобильное приложение: **Flutter**

**Обоснование выбора:**

| Критерий | Flutter | React Native | Capacitor | KMM |
|----------|---------|--------------|-----------|-----|
| Единая кодовая база | ✅ 95%+ | ✅ 90% | ✅ 85% | ⚠️ 70% |
| BLE поддержка | ✅ flutter_blue_plus | ✅ react-native-ble | ⚠️ Плагины | ✅ Нативный |
| Производительность | ✅ Компиляция в native | ⚠️ JS Bridge | ⚠️ WebView | ✅ Native |
| Графики real-time | ✅ fl_chart, syncfusion | ✅ victory-native | ⚠️ Ограничено | ⚠️ Сложно |
| Офлайн/SQLite | ✅ sqflite, drift | ✅ realm | ✅ Capacitor SQLite | ✅ SQLDelight |
| Зрелость экосистемы | ✅ Высокая | ✅ Высокая | ⚠️ Средняя | ⚠️ Растущая |
| Скорость разработки | ✅ Hot Reload | ✅ Hot Reload | ⚠️ Медленнее | ⚠️ Медленнее |

**Вывод:** Flutter обеспечивает лучший баланс производительности, кроссплатформенности и зрелости экосистемы для BLE-приложений с real-time графиками.

### 4.2 Серверная часть: **Python (FastAPI) + Go (микросервисы)**

**Обоснование:**

| Компонент | Технология | Причина |
|-----------|------------|---------|
| API Gateway | FastAPI (Python) | Быстрая разработка, async, автодокументация |
| ML/AI модуль | Python (scikit-learn, TensorFlow) | Лучшая экосистема для ML |
| Real-time сервис | Go | Высокая производительность WebSocket |
| Очереди | Redis + Celery | Надёжная обработка задач |

### 4.3 База данных: **TimescaleDB**

**Обоснование:**

| Критерий | TimescaleDB | InfluxDB | PostgreSQL |
|----------|-------------|----------|------------|
| Временные ряды | ✅ Оптимизирован | ✅ Оптимизирован | ⚠️ Возможно |
| SQL совместимость | ✅ Полная | ❌ InfluxQL/Flux | ✅ Полная |
| Сжатие данных | ✅ 90%+ | ✅ Хорошее | ⚠️ Базовое |
| Агрегации | ✅ Continuous aggregates | ✅ Tasks | ⚠️ Вручную |
| Масштабирование | ✅ Автоматическое | ⚠️ Кластер платный | ✅ Расширения |
| Экосистема | ✅ PostgreSQL | ⚠️ Специфичная | ✅ Огромная |

**Вывод:** TimescaleDB — оптимальный выбор, сочетающий преимущества PostgreSQL и специализированные функции для временных рядов.

### 4.4 Веб-панель: **Next.js + React**

**Обоснование:**

| Критерий | Next.js | Vue/Nuxt | Plain React |
|----------|---------|----------|-------------|
| SSR/SSG | ✅ Встроен | ✅ Встроен | ⚠️ Дополнительно |
| Производительность | ✅ Отличная | ✅ Хорошая | ⚠️ Зависит |
| Экосистема графиков | ✅ Recharts, Chart.js | ✅ Chart.js | ✅ Все доступны |
| Карты | ✅ react-leaflet | ✅ vue-leaflet | ✅ react-leaflet |
| TypeScript | ✅ Отличная поддержка | ✅ Хорошая | ✅ Хорошая |
| Vercel деплой | ✅ Нативный | ⚠️ Возможен | ⚠️ Возможен |

### 4.5 DevOps

| Компонент | Технология |
|-----------|------------|
| Контейнеризация | Docker |
| Оркестрация | Docker Compose (dev), Kubernetes (prod) |
| CI/CD | GitHub Actions |
| Мониторинг | Prometheus + Grafana |
| Логирование | Loki + Grafana |
| Reverse Proxy | Traefik |

---

## 5. Архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              VIBEMON ARCHITECTURE                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      BLE        ┌─────────────────┐                       │
│  │   ESP32     │◄───────────────►│  Mobile App     │                       │
│  │   Device    │                 │  (Flutter)      │                       │
│  │             │                 │                 │                       │
│  │ • MPU6050   │                 │ • BLE Manager   │                       │
│  │ • DS18B20   │                 │ • Local DB      │                       │
│  │ • BLE       │                 │ • Sync Engine   │                       │
│  │ • Flash     │                 │ • Charts        │                       │
│  └─────────────┘                 └────────┬────────┘                       │
│                                           │                                 │
│                                      HTTPS/WSS                              │
│                                           │                                 │
│  ┌────────────────────────────────────────┴─────────────────────────────┐  │
│  │                         CLOUD INFRASTRUCTURE                          │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │                        TRAEFIK (Reverse Proxy)                   │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │                                    │                                  │  │
│  │         ┌──────────────────────────┼──────────────────────────┐      │  │
│  │         │                          │                          │      │  │
│  │         ▼                          ▼                          ▼      │  │
│  │  ┌─────────────┐           ┌─────────────┐           ┌─────────────┐ │  │
│  │  │  FastAPI    │           │  Go WebSocket│           │  Next.js    │ │  │
│  │  │  REST API   │           │  Server      │           │  Admin UI   │ │  │
│  │  │             │           │              │           │             │ │  │
│  │  │ • Auth      │           │ • Real-time  │           │ • Dashboard │ │  │
│  │  │ • CRUD      │           │ • Broadcast  │           │ • Maps      │ │  │
│  │  │ • Reports   │           │ • Presence   │           │ • Users     │ │  │
│  │  └──────┬──────┘           └──────┬──────┘           └─────────────┘ │  │
│  │         │                          │                                  │  │
│  │         └──────────────┬───────────┘                                  │  │
│  │                        │                                              │  │
│  │                        ▼                                              │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │                        REDIS (Cache + Pub/Sub)                   │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │                        │                                              │  │
│  │         ┌──────────────┴───────────────────┐                         │  │
│  │         │                                  │                         │  │
│  │         ▼                                  ▼                         │  │
│  │  ┌─────────────┐                   ┌─────────────┐                   │  │
│  │  │ TimescaleDB │                   │ ML Service  │                   │  │
│  │  │             │                   │ (Python)    │                   │  │
│  │  │ • Telemetry │◄─────────────────►│             │                   │  │
│  │  │ • Users     │                   │ • Anomaly   │                   │  │
│  │  │ • Devices   │                   │ • Predict   │                   │  │
│  │  │ • Alerts    │                   │ • Train     │                   │  │
│  │  └─────────────┘                   └─────────────┘                   │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │              NOTIFICATION SERVICE (Celery Worker)               │ │  │
│  │  │  • Telegram Bot  • Email (SMTP)  • Push (FCM/APNs)             │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. План разработки

### Фаза 1: MVP (8 недель)

| Неделя | Задачи |
|--------|--------|
| 1-2 | Прототип ESP32, BLE протокол, базовый сбор данных |
| 3-4 | Backend API, база данных, аутентификация |
| 5-6 | Мобильное приложение: BLE, графики, офлайн |
| 7-8 | Интеграция, тестирование, документация |

### Фаза 2: Расширение (6 недель)

| Неделя | Задачи |
|--------|--------|
| 9-10 | Веб-панель администратора |
| 11-12 | ML модуль анализа аномалий |
| 13-14 | OTA обновления, уведомления |

### Фаза 3: Продакшн (4 недели)

| Неделя | Задачи |
|--------|--------|
| 15-16 | DevOps, CI/CD, мониторинг |
| 17-18 | Нагрузочное тестирование, оптимизация, релиз |

---

## 7. Требования к железу

### 7.1 ESP32 устройство

| Компонент | Модель | Количество | Примечание |
|-----------|--------|------------|------------|
| Микроконтроллер | ESP32-WROOM-32E | 1 | 4MB Flash, BLE 5.0 |
| Акселерометр | MPU6050 | 1 | 3-осевой, ±16g |
| Датчик температуры | DS18B20 | 1 | -55°C до +125°C |
| DC-DC конвертер | LM2596 или MP1584 | 1 | Вход 12-24V, выход 3.3V |
| TVS диод | SMBJ24A | 1 | Защита от выбросов |
| Конденсаторы | 100µF, 10µF, 0.1µF | 3 | Фильтрация |
| LED | RGB или 3x одноцветных | 1 | Индикация |
| Кнопка | Тактовая | 1 | Сброс/сопряжение |
| Разъём | XT60 или винтовой | 1 | Питание |
| Корпус | IP67 | 1 | Защита от влаги/пыли |

### 7.2 Сервер (минимальные требования)

| Параметр | Значение |
|----------|----------|
| CPU | 4 vCPU |
| RAM | 8 GB |
| SSD | 100 GB NVMe |
| Сеть | 1 Gbps |
| ОС | Ubuntu 22.04 LTS |

---

## 8. Глоссарий

| Термин | Определение |
|--------|-------------|
| BLE | Bluetooth Low Energy — энергоэффективный протокол беспроводной связи |
| OTA | Over-The-Air — обновление прошивки по воздуху |
| FFT | Fast Fourier Transform — алгоритм анализа частотного спектра вибрации |
| RMS | Root Mean Square — среднеквадратичное значение вибрации |
| MEMS | Micro-Electro-Mechanical Systems — микроэлектромеханические системы |

---

## 9. Приложения

- Приложение А: BLE протокол (отдельный документ)
- Приложение Б: API спецификация (OpenAPI)
- Приложение В: ER-диаграмма базы данных
- Приложение Г: Схема электрическая принципиальная

---

*Версия документа: 1.0*
*Дата: 2024-12-04*
*Автор: VibeMon Team*
