# Архитектура системы VibeMon

## 1. Общая архитектура

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                    VIBEMON SYSTEM                                     │
├──────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│    ┌─────────────────────────────────────────────────────────────────────────────┐   │
│    │                              EDGE LAYER                                      │   │
│    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │   │
│    │  │   ESP32     │  │   ESP32     │  │   ESP32     │  │   ESP32     │        │   │
│    │  │  Device 1   │  │  Device 2   │  │  Device 3   │  │  Device N   │        │   │
│    │  │             │  │             │  │             │  │             │        │   │
│    │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │        │   │
│    │  │ │MPU6050  │ │  │ │MPU6050  │ │  │ │MPU6050  │ │  │ │MPU6050  │ │        │   │
│    │  │ │DS18B20  │ │  │ │DS18B20  │ │  │ │DS18B20  │ │  │ │DS18B20  │ │        │   │
│    │  │ │BLE 5.0  │ │  │ │BLE 5.0  │ │  │ │BLE 5.0  │ │  │ │BLE 5.0  │ │        │   │
│    │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │        │   │
│    │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │   │
│    │         │                │                │                │               │   │
│    │         └────────────────┴────────────────┴────────────────┘               │   │
│    │                                   │ BLE                                     │   │
│    └───────────────────────────────────┼─────────────────────────────────────────┘   │
│                                        │                                             │
│    ┌───────────────────────────────────┼─────────────────────────────────────────┐   │
│    │                           MOBILE LAYER                                       │   │
│    │                                   ▼                                          │   │
│    │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│    │  │                    FLUTTER MOBILE APPLICATION                        │    │   │
│    │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │    │   │
│    │  │  │ BLE Manager │  │ Local Store │  │ Sync Engine │  │   UI/UX     │ │    │   │
│    │  │  │             │  │   (Drift)   │  │             │  │  (Flutter)  │ │    │   │
│    │  │  │ • Scan      │  │             │  │ • Queue     │  │             │ │    │   │
│    │  │  │ • Connect   │  │ • Telemetry │  │ • Retry     │  │ • Dashboard │ │    │   │
│    │  │  │ • Parse     │  │ • Devices   │  │ • Conflict  │  │ • Charts    │ │    │   │
│    │  │  │ • OTA       │  │ • Settings  │  │   Resolution│  │ • Alerts    │ │    │   │
│    │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │    │   │
│    │  └──────────────────────────────────────┬──────────────────────────────┘    │   │
│    │                                         │ HTTPS / WebSocket                 │   │
│    └─────────────────────────────────────────┼───────────────────────────────────┘   │
│                                              │                                       │
│    ┌─────────────────────────────────────────┼───────────────────────────────────┐   │
│    │                            CLOUD LAYER                                       │   │
│    │                                         ▼                                    │   │
│    │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│    │  │                        TRAEFIK INGRESS                               │    │   │
│    │  │            (Load Balancer, SSL Termination, Routing)                 │    │   │
│    │  └──────────────────────────────┬──────────────────────────────────────┘    │   │
│    │                                 │                                            │   │
│    │           ┌─────────────────────┼─────────────────────┐                     │   │
│    │           │                     │                     │                     │   │
│    │           ▼                     ▼                     ▼                     │   │
│    │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │   │
│    │  │   FastAPI       │  │   Go WebSocket  │  │    Next.js      │             │   │
│    │  │   REST API      │  │    Server       │  │   Admin Panel   │             │   │
│    │  │   (Python)      │  │                 │  │                 │             │   │
│    │  │                 │  │                 │  │                 │             │   │
│    │  │ • /api/v1/auth  │  │ • /ws/telemetry │  │ • Dashboard     │             │   │
│    │  │ • /api/v1/device│  │ • /ws/alerts    │  │ • Device List   │             │   │
│    │  │ • /api/v1/data  │  │ • Broadcasting  │  │ • Analytics     │             │   │
│    │  │ • /api/v1/alert │  │ • Presence      │  │ • User Mgmt     │             │   │
│    │  └────────┬────────┘  └────────┬────────┘  └─────────────────┘             │   │
│    │           │                    │                                            │   │
│    │           └──────────┬─────────┘                                            │   │
│    │                      │                                                       │   │
│    │                      ▼                                                       │   │
│    │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│    │  │                          REDIS CLUSTER                               │    │   │
│    │  │              (Cache, Pub/Sub, Session, Rate Limiting)                │    │   │
│    │  └──────────────────────────────┬──────────────────────────────────────┘    │   │
│    │                                 │                                            │   │
│    │           ┌─────────────────────┴─────────────────────┐                     │   │
│    │           │                                           │                     │   │
│    │           ▼                                           ▼                     │   │
│    │  ┌─────────────────────────┐             ┌─────────────────────────┐        │   │
│    │  │      TimescaleDB        │             │     ML Service          │        │   │
│    │  │                         │             │     (Python)            │        │   │
│    │  │ • hypertable: telemetry │◄───────────►│                         │        │   │
│    │  │ • table: devices        │             │ • Anomaly Detection     │        │   │
│    │  │ • table: users          │             │ • Predictive Model      │        │   │
│    │  │ • table: alerts         │             │ • FFT Analysis          │        │   │
│    │  │ • table: organizations  │             │ • Trend Analysis        │        │   │
│    │  │                         │             │                         │        │   │
│    │  │ Continuous Aggregates:  │             │ Models:                 │        │   │
│    │  │ • hourly_stats          │             │ • IsolationForest       │        │   │
│    │  │ • daily_stats           │             │ • LSTM (future)         │        │   │
│    │  └─────────────────────────┘             └─────────────────────────┘        │   │
│    │                                                                              │   │
│    │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│    │  │                    NOTIFICATION SERVICE                              │    │   │
│    │  │                      (Celery Workers)                                │    │   │
│    │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │    │   │
│    │  │  │  Telegram   │  │   Email     │  │ Push (FCM)  │                  │    │   │
│    │  │  │    Bot      │  │   (SMTP)    │  │             │                  │    │   │
│    │  │  └─────────────┘  └─────────────┘  └─────────────┘                  │    │   │
│    │  └─────────────────────────────────────────────────────────────────────┘    │   │
│    │                                                                              │   │
│    │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│    │  │                      MONITORING & LOGGING                            │    │   │
│    │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │    │   │
│    │  │  │ Prometheus  │  │   Grafana   │  │    Loki     │                  │    │   │
│    │  │  │  (Metrics)  │  │ (Dashboards)│  │   (Logs)    │                  │    │   │
│    │  │  └─────────────┘  └─────────────┘  └─────────────┘                  │    │   │
│    │  └─────────────────────────────────────────────────────────────────────┘    │   │
│    │                                                                              │   │
│    └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────┘
```

## 2. Потоки данных

### 2.1 Поток телеметрии (основной)

```
┌─────────┐    BLE     ┌─────────┐   HTTPS    ┌─────────┐   INSERT   ┌─────────────┐
│  ESP32  │──────────►│ Mobile  │───────────►│ FastAPI │───────────►│ TimescaleDB │
│         │  Packets   │   App   │   Batch    │   API   │            │             │
└─────────┘           └─────────┘            └─────────┘            └─────────────┘
                           │                      │
                           │                      │ Publish
                           │                      ▼
                           │               ┌─────────────┐
                           │               │    Redis    │
                           │               │   Pub/Sub   │
                           │               └──────┬──────┘
                           │                      │ Subscribe
                           │                      ▼
                           │               ┌─────────────┐
                           └─────WSS──────►│ Go WebSocket│
                             Real-time     │   Server    │
                                          └─────────────┘
```

### 2.2 Поток аналитики

```
┌─────────────┐   Scheduled    ┌──────────┐   Analyze   ┌─────────────┐
│ TimescaleDB │───────────────►│ ML Svc   │────────────►│   Alerts    │
│  (Raw Data) │   Query        │ (Python) │   Result    │   Table     │
└─────────────┘               └──────────┘             └──────┬──────┘
                                                              │
                               ┌──────────────────────────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
    │  Telegram   │     │    Email    │     │    Push     │
    │    Bot      │     │   Server    │     │  (FCM/APNs) │
    └─────────────┘     └─────────────┘     └─────────────┘
```

### 2.3 Поток OTA обновления

```
┌─────────────┐   Upload    ┌─────────────┐   Store     ┌─────────────┐
│   Admin     │────────────►│   FastAPI   │────────────►│    MinIO    │
│   Panel     │  Firmware   │     API     │   Binary    │   Storage   │
└─────────────┘             └─────────────┘             └──────┬──────┘
                                                               │
                                 ┌─────────────────────────────┘
                                 │ Download URL
                                 ▼
┌─────────────┐   BLE OTA   ┌─────────────┐   Download  ┌─────────────┐
│    ESP32    │◄────────────│   Mobile    │◄────────────│   FastAPI   │
│   Device    │   Chunks    │     App     │   Firmware  │     API     │
└─────────────┘             └─────────────┘             └─────────────┘
```

## 3. Компонентная диаграмма

### 3.1 Мобильное приложение (Flutter)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                           FLUTTER APPLICATION                                   │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                          PRESENTATION LAYER                              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │  Dashboard  │ │  Device     │ │   Alerts    │ │  Settings   │       │   │
│  │  │   Screen    │ │  Details    │ │   Screen    │ │   Screen    │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │   Charts    │ │ Diagnostics │ │    OTA      │ │   Profile   │       │   │
│  │  │   Screen    │ │   Screen    │ │   Screen    │ │   Screen    │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                          APPLICATION LAYER                               │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │  Device     │ │  Telemetry  │ │   Alert     │ │    Auth     │       │   │
│  │  │   Bloc      │ │    Bloc     │ │    Bloc     │ │    Bloc     │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                       │   │
│  │  │    Sync     │ │     OTA     │ │  Settings   │                       │   │
│  │  │    Bloc     │ │    Bloc     │ │    Bloc     │                       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                            DOMAIN LAYER                                  │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │   Device    │ │  Telemetry  │ │    Alert    │ │    User     │       │   │
│  │  │   Entity    │ │   Entity    │ │   Entity    │ │   Entity    │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  │  ┌───────────────────────────────────────────────────────────────┐     │   │
│  │  │                      USE CASES                                 │     │   │
│  │  │  • GetDevices  • SyncTelemetry  • CreateAlert  • Login        │     │   │
│  │  │  • ConnectBLE  • UpdateFirmware • GetHistory   • Register     │     │   │
│  │  └───────────────────────────────────────────────────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         INFRASTRUCTURE LAYER                             │   │
│  │  ┌─────────────────────────┐     ┌─────────────────────────┐            │   │
│  │  │      BLE SERVICE        │     │      API SERVICE        │            │   │
│  │  │  (flutter_blue_plus)    │     │        (Dio)            │            │   │
│  │  │                         │     │                         │            │   │
│  │  │  • Scan                 │     │  • REST Client          │            │   │
│  │  │  • Connect              │     │  • WebSocket Client     │            │   │
│  │  │  • Read/Write           │     │  • Interceptors         │            │   │
│  │  │  • OTA Transfer         │     │  • Retry Logic          │            │   │
│  │  └─────────────────────────┘     └─────────────────────────┘            │   │
│  │  ┌─────────────────────────┐     ┌─────────────────────────┐            │   │
│  │  │    LOCAL DATABASE       │     │      SYNC ENGINE        │            │   │
│  │  │       (Drift)           │     │                         │            │   │
│  │  │                         │     │  • Offline Queue        │            │   │
│  │  │  • Telemetry Table      │     │  • Conflict Resolution  │            │   │
│  │  │  • Device Table         │     │  • Background Sync      │            │   │
│  │  │  • Settings Table       │     │  • Connectivity Check   │            │   │
│  │  └─────────────────────────┘     └─────────────────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Backend (Python FastAPI)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                            FASTAPI APPLICATION                                  │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                            API LAYER                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │   /auth     │ │  /devices   │ │ /telemetry  │ │  /alerts    │       │   │
│  │  │   Router    │ │   Router    │ │   Router    │ │   Router    │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │   /users    │ │ /firmware   │ │  /reports   │ │   /orgs     │       │   │
│  │  │   Router    │ │   Router    │ │   Router    │ │   Router    │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         MIDDLEWARE LAYER                                 │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │    Auth     │ │    CORS     │ │   Logging   │ │ Rate Limit  │       │   │
│  │  │ Middleware  │ │ Middleware  │ │ Middleware  │ │ Middleware  │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                          SERVICE LAYER                                   │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │   Device    │ │  Telemetry  │ │    Alert    │ │    User     │       │   │
│  │  │   Service   │ │   Service   │ │   Service   │ │   Service   │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │  Firmware   │ │  Analytics  │ │    Org      │ │   Report    │       │   │
│  │  │   Service   │ │   Service   │ │   Service   │ │   Service   │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        REPOSITORY LAYER                                  │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │   Device    │ │  Telemetry  │ │    Alert    │ │    User     │       │   │
│  │  │    Repo     │ │    Repo     │ │    Repo     │ │    Repo     │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      INFRASTRUCTURE LAYER                                │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                │   │
│  │  │  TimescaleDB  │  │     Redis     │  │     MinIO     │                │   │
│  │  │   (asyncpg)   │  │   (aioredis)  │  │   (aioboto3)  │                │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. Диаграмма развёртывания

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                              PRODUCTION DEPLOYMENT                                  │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         KUBERNETES CLUSTER                                   │   │
│  │                                                                               │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      INGRESS NAMESPACE                               │    │   │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  │    │   │
│  │  │  │               TRAEFIK INGRESS CONTROLLER                       │  │    │   │
│  │  │  │                  (LoadBalancer Service)                        │  │    │   │
│  │  │  │                     Port 80, 443                               │  │    │   │
│  │  │  └───────────────────────────────────────────────────────────────┘  │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                    │                                         │   │
│  │  ┌─────────────────────────────────┼─────────────────────────────────────┐  │   │
│  │  │                      APP NAMESPACE                                     │  │   │
│  │  │                                 │                                       │  │   │
│  │  │    ┌────────────────────────────┼────────────────────────────────┐    │  │   │
│  │  │    │                            │                                │    │  │   │
│  │  │    ▼                            ▼                                ▼    │  │   │
│  │  │ ┌─────────────┐          ┌─────────────┐          ┌─────────────┐    │  │   │
│  │  │ │  FastAPI    │          │  Go WS      │          │  Next.js    │    │  │   │
│  │  │ │ Deployment  │          │ Deployment  │          │ Deployment  │    │  │   │
│  │  │ │ replicas: 3 │          │ replicas: 2 │          │ replicas: 2 │    │  │   │
│  │  │ │             │          │             │          │             │    │  │   │
│  │  │ │ ┌─────────┐ │          │ ┌─────────┐ │          │ ┌─────────┐ │    │  │   │
│  │  │ │ │  Pod 1  │ │          │ │  Pod 1  │ │          │ │  Pod 1  │ │    │  │   │
│  │  │ │ ├─────────┤ │          │ ├─────────┤ │          │ ├─────────┤ │    │  │   │
│  │  │ │ │  Pod 2  │ │          │ │  Pod 2  │ │          │ │  Pod 2  │ │    │  │   │
│  │  │ │ ├─────────┤ │          │ └─────────┘ │          │ └─────────┘ │    │  │   │
│  │  │ │ │  Pod 3  │ │          │             │          │             │    │  │   │
│  │  │ │ └─────────┘ │          │             │          │             │    │  │   │
│  │  │ └──────┬──────┘          └──────┬──────┘          └─────────────┘    │  │   │
│  │  │        │                        │                                     │  │   │
│  │  │        └────────────┬───────────┘                                     │  │   │
│  │  │                     │                                                  │  │   │
│  │  │                     ▼                                                  │  │   │
│  │  │              ┌─────────────┐                                          │  │   │
│  │  │              │    Redis    │                                          │  │   │
│  │  │              │  StatefulSet│                                          │  │   │
│  │  │              │  replicas: 3│                                          │  │   │
│  │  │              │  (Sentinel) │                                          │  │   │
│  │  │              └─────────────┘                                          │  │   │
│  │  │                                                                        │  │   │
│  │  │  ┌─────────────┐          ┌─────────────┐                             │  │   │
│  │  │  │ ML Service  │          │   Celery    │                             │  │   │
│  │  │  │ Deployment  │          │   Workers   │                             │  │   │
│  │  │  │ replicas: 2 │          │ replicas: 3 │                             │  │   │
│  │  │  └─────────────┘          └─────────────┘                             │  │   │
│  │  └────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                               │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      DATA NAMESPACE                                  │    │   │
│  │  │  ┌───────────────────┐              ┌───────────────────┐           │    │   │
│  │  │  │   TimescaleDB     │              │      MinIO        │           │    │   │
│  │  │  │   StatefulSet     │              │   StatefulSet     │           │    │   │
│  │  │  │   replicas: 2     │              │   replicas: 4     │           │    │   │
│  │  │  │   (Primary+Replica)│              │   (Distributed)   │           │    │   │
│  │  │  │                   │              │                   │           │    │   │
│  │  │  │   PVC: 500GB      │              │   PVC: 100GB x 4  │           │    │   │
│  │  │  └───────────────────┘              └───────────────────┘           │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                               │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │                    MONITORING NAMESPACE                              │    │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │    │   │
│  │  │  │ Prometheus  │  │   Grafana   │  │    Loki     │                  │    │   │
│  │  │  │ StatefulSet │  │ Deployment  │  │ StatefulSet │                  │    │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘                  │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                               │   │
│  └───────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

## 5. Сетевая диаграмма

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                 NETWORK DIAGRAM                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   INTERNET                                                                           │
│      │                                                                               │
│      │ HTTPS (443)                                                                   │
│      ▼                                                                               │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        CLOUDFLARE (CDN + WAF + DDoS)                          │  │
│   │                              vibemon.io                                        │  │
│   └────────────────────────────────────┬─────────────────────────────────────────┘  │
│                                        │                                             │
│                                        │ HTTPS (443)                                 │
│                                        ▼                                             │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                      LOAD BALANCER (Cloud Provider)                           │  │
│   │                          Public IP: x.x.x.x                                    │  │
│   └────────────────────────────────────┬─────────────────────────────────────────┘  │
│                                        │                                             │
│   ══════════════════════════════════════════════════════════════════════════════    │
│                                   VPC / VNET                                         │
│                                10.0.0.0/16                                           │
│   ══════════════════════════════════════════════════════════════════════════════    │
│                                        │                                             │
│   ┌────────────────────────────────────┼────────────────────────────────────────┐   │
│   │              PUBLIC SUBNET (10.0.1.0/24)                                     │   │
│   │                                    │                                         │   │
│   │  ┌─────────────────────────────────┴─────────────────────────────────────┐  │   │
│   │  │                    TRAEFIK INGRESS (NodePort)                          │  │   │
│   │  │                        10.0.1.10:80, 443                               │  │   │
│   │  └─────────────────────────────────┬─────────────────────────────────────┘  │   │
│   │                                    │                                         │   │
│   └────────────────────────────────────┼────────────────────────────────────────┘   │
│                                        │                                             │
│   ┌────────────────────────────────────┼────────────────────────────────────────┐   │
│   │            PRIVATE SUBNET - APP (10.0.10.0/24)                               │   │
│   │                                    │                                         │   │
│   │    ┌───────────────────────────────┼───────────────────────────────────┐    │   │
│   │    │                               │                                   │    │   │
│   │    ▼                               ▼                                   ▼    │   │
│   │ ┌─────────────┐             ┌─────────────┐             ┌─────────────┐    │   │
│   │ │  FastAPI    │             │   Go WS     │             │  Next.js    │    │   │
│   │ │ 10.0.10.11  │             │ 10.0.10.12  │             │ 10.0.10.13  │    │   │
│   │ │  Port 8000  │             │  Port 8080  │             │  Port 3000  │    │   │
│   │ └──────┬──────┘             └──────┬──────┘             └─────────────┘    │   │
│   │        │                           │                                        │   │
│   │        └───────────────┬───────────┘                                        │   │
│   │                        │                                                     │   │
│   │                        ▼                                                     │   │
│   │                 ┌─────────────┐                                              │   │
│   │                 │    Redis    │                                              │   │
│   │                 │ 10.0.10.20  │                                              │   │
│   │                 │  Port 6379  │                                              │   │
│   │                 └─────────────┘                                              │   │
│   │                                                                               │   │
│   │ ┌─────────────┐             ┌─────────────┐                                  │   │
│   │ │ ML Service  │             │   Celery    │                                  │   │
│   │ │ 10.0.10.30  │             │ 10.0.10.31  │                                  │   │
│   │ │  Port 8001  │             │             │                                  │   │
│   │ └─────────────┘             └─────────────┘                                  │   │
│   │                                                                               │   │
│   └───────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                             │
│   ┌────────────────────────────────────┼────────────────────────────────────────┐   │
│   │            PRIVATE SUBNET - DATA (10.0.20.0/24)                              │   │
│   │                                    │                                         │   │
│   │    ┌───────────────────────────────┴───────────────────────────────┐        │   │
│   │    │                                                               │        │   │
│   │    ▼                                                               ▼        │   │
│   │ ┌─────────────────────────┐                     ┌─────────────────────────┐ │   │
│   │ │      TimescaleDB        │                     │        MinIO            │ │   │
│   │ │      10.0.20.10         │                     │      10.0.20.20         │ │   │
│   │ │      Port 5432          │                     │      Port 9000          │ │   │
│   │ │                         │                     │                         │ │   │
│   │ │  Primary: 10.0.20.10    │                     │  Node1: 10.0.20.20      │ │   │
│   │ │  Replica: 10.0.20.11    │                     │  Node2: 10.0.20.21      │ │   │
│   │ └─────────────────────────┘                     └─────────────────────────┘ │   │
│   │                                                                               │   │
│   └───────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

## 6. Диаграмма последовательности: Подключение устройства

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌───────────┐
│  ESP32  │     │ Mobile  │     │ FastAPI │     │  Redis  │     │TimescaleDB│
│ Device  │     │   App   │     │   API   │     │         │     │           │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     └─────┬─────┘
     │               │               │               │                 │
     │  BLE Advertise│               │               │                 │
     │──────────────►│               │               │                 │
     │               │               │               │                 │
     │               │ Scan for      │               │                 │
     │               │ devices       │               │                 │
     │◄──────────────│               │               │                 │
     │               │               │               │                 │
     │ BLE Connect   │               │               │                 │
     │◄──────────────│               │               │                 │
     │               │               │               │                 │
     │ Read Device   │               │               │                 │
     │ Info          │               │               │                 │
     │◄──────────────│               │               │                 │
     │──────────────►│               │               │                 │
     │  Device Info  │               │               │                 │
     │               │               │               │                 │
     │               │ POST /devices │               │                 │
     │               │ (register)    │               │                 │
     │               │──────────────►│               │                 │
     │               │               │               │                 │
     │               │               │ Check exists  │                 │
     │               │               │───────────────────────────────►│
     │               │               │◄───────────────────────────────│
     │               │               │               │                 │
     │               │               │ INSERT device │                 │
     │               │               │───────────────────────────────►│
     │               │               │◄───────────────────────────────│
     │               │               │               │                 │
     │               │               │ Pub: device   │                 │
     │               │               │ connected     │                 │
     │               │               │──────────────►│                 │
     │               │               │               │                 │
     │               │◄──────────────│               │                 │
     │               │  Device ID    │               │                 │
     │               │               │               │                 │
     │ Subscribe     │               │               │                 │
     │ Notifications │               │               │                 │
     │◄──────────────│               │               │                 │
     │               │               │               │                 │
     │ Enable        │               │               │                 │
     │ Telemetry     │               │               │                 │
     │◄──────────────│               │               │                 │
     │               │               │               │                 │
     │ Telemetry     │               │               │                 │
     │ Packets       │               │               │                 │
     │──────────────►│               │               │                 │
     │──────────────►│               │               │                 │
     │──────────────►│               │               │                 │
     │               │               │               │                 │
     │               │ Batch POST    │               │                 │
     │               │ /telemetry    │               │                 │
     │               │──────────────►│               │                 │
     │               │               │               │                 │
     │               │               │ INSERT batch  │                 │
     │               │               │───────────────────────────────►│
     │               │               │◄───────────────────────────────│
     │               │               │               │                 │
     │               │               │ Pub: new_data │                 │
     │               │               │──────────────►│                 │
     │               │               │               │                 │
     │               │◄──────────────│               │                 │
     │               │    200 OK     │               │                 │
     │               │               │               │                 │
┌────┴────┐     ┌────┴────┐     ┌────┴────┐     ┌────┴────┐     ┌─────┴─────┐
│  ESP32  │     │ Mobile  │     │ FastAPI │     │  Redis  │     │TimescaleDB│
│ Device  │     │   App   │     │   API   │     │         │     │           │
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └───────────┘
```

## 7. Состояния устройства ESP32

```
                              ┌─────────────────┐
                              │     POWER ON    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  INITIALIZING   │
                              │  • Load config  │
                              │  • Init sensors │
                              │  • Init BLE     │
                              └────────┬────────┘
                                       │
                      ┌────────────────┼────────────────┐
                      │                │                │
                      ▼                ▼                ▼
             ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
             │   PAIRING   │  │ ADVERTISING │  │    ERROR    │
             │   MODE      │  │   (Normal)  │  │    STATE    │
             │             │  │             │  │             │
             │ LED: Blink  │  │ LED: Slow   │  │ LED: Red    │
             │ Blue Fast   │  │ Pulse Blue  │  │ Blink       │
             └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
                    │                │                │
                    │                │                │ Retry
                    │                │                └────────┐
                    │                │                         │
                    ▼                ▼                         │
             ┌─────────────────────────────────────────────────┴──┐
             │                    CONNECTED                        │
             │                                                     │
             │   ┌─────────────────────────────────────────────┐  │
             │   │              SUB-STATES                      │  │
             │   │                                              │  │
             │   │  ┌─────────────┐      ┌─────────────┐       │  │
             │   │  │   IDLE      │      │  STREAMING  │       │  │
             │   │  │             │◄────►│             │       │  │
             │   │  │ LED: Green  │      │ LED: Green  │       │  │
             │   │  │ Solid       │      │ Blink       │       │  │
             │   │  └─────────────┘      └─────────────┘       │  │
             │   │         │                    │               │  │
             │   │         │         ┌──────────┘               │  │
             │   │         │         │                          │  │
             │   │         ▼         ▼                          │  │
             │   │  ┌─────────────────────┐                     │  │
             │   │  │    OTA UPDATE       │                     │  │
             │   │  │                     │                     │  │
             │   │  │ LED: Purple Blink   │                     │  │
             │   │  └──────────┬──────────┘                     │  │
             │   │             │                                │  │
             │   │             ▼                                │  │
             │   │  ┌─────────────────────┐                     │  │
             │   │  │    REBOOTING        │                     │  │
             │   │  └─────────────────────┘                     │  │
             │   │                                              │  │
             │   └──────────────────────────────────────────────┘  │
             │                                                     │
             └──────────────────────────┬──────────────────────────┘
                                        │
                                        │ Disconnect / Timeout
                                        ▼
                               ┌─────────────────┐
                               │  DISCONNECTED   │
                               │                 │
                               │  • Buffer data  │
                               │  • Deep sleep   │
                               │    timer        │
                               └────────┬────────┘
                                        │
                        ┌───────────────┴───────────────┐
                        │                               │
                        ▼                               ▼
               ┌─────────────────┐             ┌─────────────────┐
               │   DEEP SLEEP    │             │   RECONNECT     │
               │                 │             │   ATTEMPT       │
               │  Wake on:       │             │                 │
               │  • Timer        │────────────►│                 │
               │  • Button       │             │                 │
               │  • Threshold    │             │                 │
               └─────────────────┘             └─────────────────┘
```

---

*Документ: Архитектура системы VibeMon v1.0*
